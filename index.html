<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ConnHlem</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PWA: GitHub Pages用に相対パス -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#3b82f6" />
  <link rel="apple-touch-icon" href="icons/icon.png" />

  <!-- Icons lib -->
  <script src="https://unpkg.com/@phosphor-icons/web@2.0.3/dist/phosphor.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');

    :root { --gradient-x: 50%; --gradient-y: 50%; }
    html, body { height: 100%; }
    body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      min-height: 100vh;
      background: radial-gradient(at var(--gradient-x) var(--gradient-y), #a6c0e8, #d1cbf4, #f2e2f3);
      background-size: 200% 200%;
      transition: background 0.5s ease-in-out;
      color: #1a202c;
      overflow-x: hidden;
    }
    .dark body {
      background: radial-gradient(at var(--gradient-x) var(--gradient-y), #2c5364, #203a43, #0f2027);
      background-size: 200% 200%;
      color: #e2e8f0;
    }

    .container-glass,.card-container,.total-card,.transaction-item,.modal-glass{
      backdrop-filter: blur(25px) saturate(180%);
      -webkit-backdrop-filter: blur(25px) saturate(180%);
      border: 1px solid rgba(255,255,255,0.4);
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      background-color: rgba(255,255,255,0.4);
      transition: background-color .5s,border-color .5s,box-shadow .5s;
    }
    .dark .container-glass,.dark .card-container,.dark .total-card,.dark .transaction-item,.dark .modal-glass{
      background-color: rgba(0,0,0,0.4);
      border: 1px solid rgba(0,0,0,0.4);
      box-shadow: 0 10px 40px rgba(255,255,255,0.1);
    }
    .card-container,.transaction-item,.total-card,.input-glass{
      transition: transform .3s cubic-bezier(.4,0,.2,1), box-shadow .3s, background-color .3s;
    }
    .card-container:hover,.transaction-item:hover,.total-card:hover{
      transform: translateY(-4px) scale(1.01);
      box-shadow: 0 12px 20px rgba(0,0,0,0.1);
    }
    .dark .card-container:hover,.dark .transaction-item:hover,.dark .total-card:hover{
      box-shadow: 0 12px 20px rgba(255,255,255,0.1);
    }
    .blacklisted-user-card{ filter:grayscale(100%); opacity:.7; }
    .repaid-transaction{ opacity:.6; text-decoration:line-through; }
    .fade-in-up{ animation:fadeInUp .6s cubic-bezier(.25,.46,.45,.94) forwards; }
    @keyframes fadeInUp{ from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
    .modal-fade-in{ animation: modalFadeIn .3s cubic-bezier(.25,.46,.45,.94) forwards; }
    @keyframes modalFadeIn{ from{opacity:0;transform:scale(.8)} to{opacity:1;transform:scale(1)} }
    .rotate-45{ transform: rotate(45deg); }
  </style>
</head>

<body class="flex flex-col items-center p-4 sm:p-8">
  <!-- ▼ ConnHlem ログイン画面 -->
  <div id="loginBox" class="fixed inset-0 hidden items-center justify-center bg-black/30 backdrop-blur-sm p-4 z-50">
  <div id="loginBox" class="fixed inset-0 flex items-center justify-center bg-black/30 backdrop-blur-sm p-4 z-50">
    <div class="w-full max-w-sm rounded-2xl bg-white/90 dark:bg-black/70 p-6 shadow-xl">
      <h2 class="text-2xl font-bold mb-4 text-center">ConnHlem ログイン</h2>
      <label class="block mb-2 text-sm">メールアドレス</label>
      <input id="loginEmail" type="email" class="w-full mb-3 p-3 rounded border" placeholder="you@example.com">
      <label class="block mb-2 text-sm">パスワード</label>
      <input id="loginPassword" type="password" class="w-full mb-4 p-3 rounded border" placeholder="********">
      <div class="flex gap-2">
        <button id="loginBtn"  class="flex-1 py-2 rounded bg-blue-600 text-white">ログイン</button>
        <button id="signupBtn" class="flex-1 py-2 rounded bg-gray-700 text-white">新規作成</button>
      </div>
      <p id="loginMsg" class="text-sm text-red-600 mt-3"></p>
      <p class="mt-3 text-sm text-blue-600 underline cursor-pointer" id="forgotLink">パスワードを忘れた？</p>
    </div>
  </div>
  <!-- ▲ ConnHlem ログイン画面 -->

  <!-- ログアウト（表示はログイン時のみ） -->
  <button id="logoutBtn" class="fixed top-4 left-4 z-40 px-3 py-2 rounded-full bg-gray-700 text-white hidden">ログアウト</button>

  <!-- ダークモード切り替え -->
  <button id="modeToggleBtn" class="fixed top-4 right-4 z-40 p-3 rounded-full shadow-lg transition-all border border-gray-200 dark:border-gray-800 bg-white/30 dark:bg-black/30 backdrop-blur-md hover:bg-white/50 dark:hover:bg-black/50 focus:outline-none">
    <i id="modeIcon" class="ph-bold ph-sun text-2xl text-gray-800 dark:text-gray-200 transition-transform hover:scale-110"></i>
  </button>

  <!-- メイン -->
@@ -580,87 +580,88 @@

    // ログインUI
    const loginBox = document.getElementById('loginBox');
    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const loginMsg = document.getElementById('loginMsg');
    const forgotLink = document.getElementById('forgotLink');
    const logoutBtn = document.getElementById('logoutBtn');

    // ログイン
    loginBtn?.addEventListener('click', async () => {
      loginMsg.textContent = '';
      try { await signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value); }
      catch (e) { loginMsg.textContent = 'ログインに失敗しました（メール/パスワードを確認）'; }
    });

// 新規作成＋確認メール
signupBtn?.addEventListener('click', async () => {
  loginMsg.textContent = '';
  try {
    await createUserWithEmailAndPassword(auth, loginEmail.value, loginPassword.value);
    try { await sendEmailVerification(auth.currentUser); } catch(_) {}
    const ref = doc(db, 'connhlem', auth.currentUser.uid);
    await setDoc(ref, { users: [], transactions: [], updatedAt: Date.now() }, { merge: true });
-   loginMsg.textContent = 'アカウント作成OK。確認メールを送信しました（メールのリンクを開いてください）。';
+   loginMsg.textContent = 'アカウント作成OK。確認メールを送信しました（メールのリンクを開いてください）。';
  } catch (e) {
-   loginMsg.textContent = 'アカウント作成に失敗しました（既に使われている可能性）。';
+   loginMsg.textContent = `登録失敗: ${e.code}`;
+   console.error(e);
  }
    await setDoc(ref, { users: [], transactions: [], updatedAt: Date.now() }, { merge: true });
    loginMsg.textContent = 'アカウント作成OK。確認メールを送信しました（メールのリンクを開いてください）。';
  } catch (e) {
    loginMsg.textContent = `登録失敗: ${e.code}`;
    console.error(e);
  }
});


    // パスワード再発行
    forgotLink?.addEventListener('click', async () => {
      const email = (loginEmail?.value || '').trim();
      if (!email) { loginMsg.textContent = '再発行するメールアドレスを入力してください。'; return; }
      try {
        await sendPasswordResetEmail(auth, email);
        loginMsg.textContent = 'パスワード再設定メールを送信しました。メールを確認してください。';
      } catch (e) {
        loginMsg.textContent = '送信に失敗しました。メールアドレスを確認してください。';
      }
    });

    // 認証状態
    let syncing = false;
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        loginBox?.classList.remove('hidden'); loginBox?.classList.add('flex');
        logoutBtn?.classList.add('hidden');
        return;
      }
      if (!user.emailVerified) {
        loginMsg.textContent = 'メールアドレスの確認が必要です。メール内のリンクを開いた後にログインしてください。';
        loginBox?.classList.remove('hidden'); loginBox?.classList.add('flex');
        logoutBtn?.classList.add('hidden');
        return;
      }
      // メール確認を有効にする場合は以下をコメント解除
      /*
      if (!user.emailVerified) {
        loginMsg.textContent = 'メールアドレスの確認が必要です。メール内のリンクを開いた後にログインしてください。';
        loginBox?.classList.remove('hidden'); loginBox?.classList.add('flex');
        logoutBtn?.classList.add('hidden');
        return;
      }
      */

      // ログイン成功
      loginBox?.classList.add('hidden'); loginBox?.classList.remove('flex');
      logoutBtn?.classList.remove('hidden');

      const ref = doc(db, 'connhlem', user.uid);

      // クラウド → UIへ自動反映
      onSnapshot(ref, (snap) => {
        if (!snap.exists()) return;
        const d = snap.data();
        syncing = true;
        window.users = Array.isArray(d.users) ? d.users : [];
        window.transactions = Array.isArray(d.transactions) ? d.transactions : [];
        _saveLocal && _saveLocal();
        _renderUI && _renderUI();
        syncing = false;
      });

      // 初回：クラウドが空なら手元データをアップ
      const cur = await getDoc(ref);
      if (!cur.exists()) {
        await setDoc(ref, { users: window.users||[], transactions: window.transactions||[], updatedAt: Date.now() }, { merge: true });
      }
    });
